tests:
- name: "Successful test with hooks, validation, and assertions"
  patches:
    xrd: ../../aws/xrd.yaml
  inputs:
    xr: ../../aws/xr.yaml
    composition: ../../aws/composition.yaml
    functions: ../../aws/functions.yaml
    observed-resources: ../../aws/observed
    crds:
    - ../../aws/xrd.yaml
    - ../../aws/crossplane.yaml
  hooks:
    pre-test:
    - name: "Pre-test hook"
      run: echo "running pre-test hook"
    - name: "Pre-test hook (multiline stdout)"
      run: |
        echo "line one"
        echo "line two"
        echo "line three"
    - run: echo "unnamed pre-test hook"
    post-test:
    - name: "Post-test hook"
      run: echo "running post-test hook"
    - name: "Post-test hook (multiline stdout)"
      run: |
        echo "output A"
        echo "output B"
        echo "output C"
    - run: echo "unnamed post-test hook"
  assertions:
    xprin:
    - name: "Number of resources"
      type: "Count"
      value: 3
    - name: "SecurityGroup should exist"
      type: "Exists"
      resource: "SecurityGroup/platform-aws-sg"
    - name: "RDS should exist"
      type: "Exists"
      resource: "Cluster/platform-aws-rds"
    - name: "SecurityGroup should have a name"
      type: "FieldExists"
      resource: "SecurityGroup/platform-aws-sg"
      field: "metadata.name"
    - name: "SecurityGroup description should be string"
      type: "FieldType"
      resource: "SecurityGroup/platform-aws-sg"
      field: "spec.forProvider.description"
      value: "string"

- name: "CRDs with same base name are not overwritten"
  inputs:
    xr: ../../aws/xr.yaml
    composition: ../../aws/composition.yaml
    functions: ../../aws/functions.yaml
    crds:
    - ../../base/xrd.yaml
    - ../../aws/xrd.yaml
    - ../../gcp/xrd.yaml
    - ../../aws/crossplane.yaml
  hooks:
    post-test:
    - name: "List CRDs in inputs (xrd.yaml, xrd_1.yaml, xrd_2.yaml, ...)"
      run: ls $(dirname {{ index .Inputs.CRDs 0 }})
    - name: "Verify all 3 XRD files present (not overwritten)"
      run: test -f {{ index .Inputs.CRDs 0 }} && test -f {{ index .Inputs.CRDs 1 }} && test -f {{ index .Inputs.CRDs 2 }} && echo "All 3 CRDs present (not overwritten)"
